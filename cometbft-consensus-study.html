<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CometBFT Consensus ì™„ë²½ ê°€ì´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            line-height: 1.8;
            color: #333;
            background: #f5f7fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 20px;
            text-align: center;
            margin-bottom: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.3em;
            opacity: 0.95;
        }

        .toc {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }

        .toc h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .toc ul {
            list-style: none;
        }

        .toc li {
            margin: 12px 0;
            padding-left: 20px;
        }

        .toc a {
            color: #555;
            text-decoration: none;
            font-size: 1.1em;
            transition: all 0.3s;
            display: block;
            padding: 8px 12px;
            border-radius: 5px;
        }

        .toc a:hover {
            background: #f0f0f0;
            color: #667eea;
            transform: translateX(10px);
        }

        .toc .sub-item {
            padding-left: 40px;
            font-size: 0.95em;
        }

        section {
            background: white;
            padding: 40px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h2 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
            padding-left: 20px;
        }

        h3 {
            color: #764ba2;
            font-size: 1.8em;
            margin-top: 35px;
            margin-bottom: 20px;
        }

        h4 {
            color: #555;
            font-size: 1.4em;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        p {
            margin-bottom: 15px;
            font-size: 1.05em;
        }

        .highlight {
            background: #fff3cd;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
        }

        .emoji {
            font-size: 1.3em;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            color: #e83e8c;
        }

        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            line-height: 1.5;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        pre code {
            background: none;
            color: inherit;
            padding: 0;
        }

        .diagram {
            background: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 25px;
            margin: 25px 0;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
            line-height: 1.6;
        }

        .flow-box {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .flow-box h4 {
            color: #667eea;
            margin-top: 0;
        }

        .note {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .arrow {
            text-align: center;
            font-size: 1.5em;
            color: #667eea;
            margin: 10px 0;
        }

        ul, ol {
            margin: 15px 0 15px 30px;
        }

        li {
            margin: 8px 0;
        }

        .key-point {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin: 25px 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .key-point h4 {
            color: white;
            margin-top: 0;
        }

        footer {
            text-align: center;
            padding: 40px;
            color: #777;
            margin-top: 50px;
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 25px 0;
        }

        .comparison-item {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .comparison-item h4 {
            margin-top: 0;
        }

        @media (max-width: 768px) {
            .comparison {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 2em;
            }

            h2 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš€ CometBFT Consensus ì™„ë²½ ê°€ì´ë“œ</h1>
            <p>ê²°ì œ ì²´ì¸ì„ ìœ„í•œ ì»¨ì„¼ì„œìŠ¤ ì—”ì§„ ì™„ì „ ì •ë³µ</p>
        </header>

        <nav class="toc">
            <h2>ğŸ“š ëª©ì°¨</h2>
            <ul>
                <li><a href="#intro">1. CometBFT ê°œìš”</a></li>
                <li class="sub-item"><a href="#architecture">ì „ì²´ ì•„í‚¤í…ì²˜</a></li>
                <li class="sub-item"><a href="#core-concepts">í•µì‹¬ ê°œë…</a></li>

                <li><a href="#state">2. State êµ¬ì¡°ì²´ì™€ ë™ì‹œì„±</a></li>
                <li class="sub-item"><a href="#state-structure">State êµ¬ì¡°ì²´</a></li>
                <li class="sub-item"><a href="#lock-mechanism">ë½(Lock) ë©”ì»¤ë‹ˆì¦˜</a></li>

                <li><a href="#consensus-flow">3. ì»¨ì„¼ì„œìŠ¤ íë¦„</a></li>
                <li class="sub-item"><a href="#receive-routine">receiveRoutine - ë©”ì¸ ë£¨í”„</a></li>
                <li class="sub-item"><a href="#vote-processing">íˆ¬í‘œ ì²˜ë¦¬</a></li>
                <li class="sub-item"><a href="#consensus-steps">ì»¨ì„¼ì„œìŠ¤ ë‹¨ê³„ë“¤</a></li>

                <li><a href="#block-parts">4. ë¸”ë¡ ì¡°ê°ê³¼ P2P</a></li>
                <li class="sub-item"><a href="#partset">ë¸”ë¡ ì¡°ê° (PartSet)</a></li>
                <li class="sub-item"><a href="#p2p-concurrency">P2P ë™ì‹œì„±</a></li>

                <li><a href="#abci">5. ABCI ì¸í„°í˜ì´ìŠ¤</a></li>
                <li class="sub-item"><a href="#abci-methods">ì£¼ìš” ë©”ì„œë“œ</a></li>
                <li class="sub-item"><a href="#execution">ë¸”ë¡ ì‹¤í–‰</a></li>

                <li><a href="#mempool">6. Mempool</a></li>
                <li class="sub-item"><a href="#mempool-structure">êµ¬ì¡°ì™€ ë™ì‘</a></li>
                <li class="sub-item"><a href="#mempool-optimization">ê²°ì œ ì²´ì¸ ìµœì í™”</a></li>

                <li><a href="#summary">7. ì •ë¦¬ ë° ê²°ë¡ </a></li>
            </ul>
        </nav>

        <!-- 1. ì†Œê°œ -->
        <section id="intro">
            <h2>1. <span class="emoji">ğŸ¯</span> CometBFT ê°œìš”</h2>

            <p><strong>CometBFT</strong>ëŠ” Byzantine Fault Tolerant ì»¨ì„¼ì„œìŠ¤ ì—”ì§„ìœ¼ë¡œ, Cosmos ìƒíƒœê³„ì˜ í•µì‹¬ ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.
            Tendermint ì»¨ì„¼ì„œìŠ¤ ì•Œê³ ë¦¬ì¦˜ì„ êµ¬í˜„í•˜ë©°, ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ê³¼ ì»¨ì„¼ì„œìŠ¤ ë ˆì´ì–´ë¥¼ ë¶„ë¦¬í•˜ëŠ” ABCI(Application Blockchain Interface)ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</p>

            <div class="key-point">
                <h4>í•µì‹¬ íŠ¹ì§•</h4>
                <ul>
                    <li><strong>ì¦‰ì‹œ ìµœì¢…ì„±(Instant Finality)</strong>: ë¸”ë¡ í™•ì • ì¦‰ì‹œ ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ</li>
                    <li><strong>Byzantine Fault Tolerance</strong>: ìµœëŒ€ 1/3 ì•…ì˜ì  ë…¸ë“œ í—ˆìš©</li>
                    <li><strong>ê³ ì„±ëŠ¥</strong>: ì´ˆë‹¹ ìˆ˜ì²œ íŠ¸ëœì­ì…˜ ì²˜ë¦¬</li>
                    <li><strong>ABCI</strong>: ì–´ë–¤ ì–¸ì–´ë¡œë“  ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œ ê°€ëŠ¥</li>
                </ul>
            </div>

            <h3 id="architecture">ì „ì²´ ì•„í‚¤í…ì²˜</h3>

            <div class="diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CometBFT Node êµ¬ì¡°                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Consensus   â”‚    â”‚   Mempool    â”‚          â”‚
â”‚  â”‚    Engine    â”‚â—„â”€â”€â”€â”¤   (Tx Pool)  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                                        â”‚
â”‚         â”‚ ABCI                                   â”‚
â”‚         â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚     Application Layer        â”‚               â”‚
â”‚  â”‚   (ê²°ì œ ë¡œì§, ìƒíƒœ ê´€ë¦¬)      â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚         â–²                                        â”‚
â”‚         â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Block Store â”‚    â”‚  State Store â”‚          â”‚
â”‚  â”‚   (Blocks)   â”‚    â”‚   (AppHash)  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚      P2P Network Layer       â”‚               â”‚
â”‚  â”‚  (ë‹¤ë¥¸ ë…¸ë“œë“¤ê³¼ í†µì‹ )         â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>

            <h3 id="core-concepts">í•µì‹¬ ê°œë…</h3>

            <table>
                <thead>
                    <tr>
                        <th>ê°œë…</th>
                        <th>ì„¤ëª…</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Height</strong></td>
                        <td>ë¸”ë¡ ë†’ì´ (1, 2, 3, ...)</td>
                    </tr>
                    <tr>
                        <td><strong>Round</strong></td>
                        <td>ê°™ì€ ë†’ì´ì—ì„œ í•©ì˜ ì‹œë„ íšŸìˆ˜ (0, 1, 2, ...)</td>
                    </tr>
                    <tr>
                        <td><strong>Validator</strong></td>
                        <td>ë¸”ë¡ì„ ì œì•ˆí•˜ê³  íˆ¬í‘œí•˜ëŠ” ê²€ì¦ì</td>
                    </tr>
                    <tr>
                        <td><strong>Proposer</strong></td>
                        <td>ë¸”ë¡ì„ ì œì•ˆí•˜ëŠ” ê²€ì¦ì (ë¼ìš´ë“œë§ˆë‹¤ ìˆœí™˜)</td>
                    </tr>
                    <tr>
                        <td><strong>Vote</strong></td>
                        <td>ê²€ì¦ìì˜ íˆ¬í‘œ (Prevote, Precommit)</td>
                    </tr>
                    <tr>
                        <td><strong>2/3 Majority</strong></td>
                        <td>ì „ì²´ íˆ¬í‘œë ¥ì˜ 2/3 ì´ìƒ</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- 2. State êµ¬ì¡°ì²´ -->
        <section id="state">
            <h2>2. <span class="emoji">ğŸ—ï¸</span> State êµ¬ì¡°ì²´ì™€ ë™ì‹œì„±</h2>

            <h3 id="state-structure">State êµ¬ì¡°ì²´</h3>

            <p>StateëŠ” ì»¨ì„¼ì„œìŠ¤ì˜ ëª¨ë“  ì •ë³´ë¥¼ ë‹´ê³  ìˆëŠ” í•µì‹¬ êµ¬ì¡°ì²´ì…ë‹ˆë‹¤.</p>

            <pre><code>type State struct {
    // === ì±„ë„ë“¤ (ë©”ì‹œì§€ ì „ë‹¬ìš©) ===
    peerMsgQueue     chan msgInfo  // P2Pì—ì„œ ì˜¨ ë©”ì‹œì§€
    internalMsgQueue chan msgInfo  // ë‚´ë¶€ ë©”ì‹œì§€
    timeoutTicker    TimeoutTicker // íƒ€ì„ì•„ì›ƒ

    // === ë½ìœ¼ë¡œ ë³´í˜¸ë˜ëŠ” ê³µìœ  ë°ì´í„° ===
    mtx cmtsync.RWMutex

    // ì»¨ì„¼ì„œìŠ¤ ìƒíƒœ
    Height    int64         // í˜„ì¬ ë¸”ë¡ ë†’ì´
    Round     int32         // í˜„ì¬ ë¼ìš´ë“œ
    Step      RoundStepType // í˜„ì¬ ë‹¨ê³„

    // ë¸”ë¡ ì •ë³´
    Proposal           *types.Proposal
    ProposalBlock      *types.Block
    ProposalBlockParts *types.PartSet

    // Lock ì •ë³´
    LockedRound      int32
    LockedBlock      *types.Block

    // íˆ¬í‘œ ì •ë³´
    Votes      *HeightVoteSet  // ğŸ”¥ ëª¨ë“  íˆ¬í‘œ
    LastCommit *types.VoteSet

    // ê²€ì¦ì ì •ë³´
    Validators *types.ValidatorSet
}</code></pre>

            <h3 id="lock-mechanism">ë½(Lock) ë©”ì»¤ë‹ˆì¦˜</h3>

            <div class="note">
                <h4>ì™œ ë½ì´ í•„ìš”í• ê¹Œ?</h4>
                <p>CometBFTëŠ” ì—¬ëŸ¬ ê³ ë£¨í‹´ì´ ë™ì‹œì— Stateì— ì ‘ê·¼í•©ë‹ˆë‹¤:</p>
                <ul>
                    <li><strong>receiveRoutine</strong>: ë©”ì‹œì§€ ì²˜ë¦¬ (ì“°ê¸°)</li>
                    <li><strong>P2P Reactor</strong>: ìƒíƒœ ì½ê¸°</li>
                    <li><strong>RPC Handler</strong>: ì‚¬ìš©ì ì¿¼ë¦¬ ì²˜ë¦¬ (ì½ê¸°)</li>
                </ul>
            </div>

            <h4>Race Condition ì˜ˆì‹œ</h4>

            <div class="comparison">
                <div class="comparison-item">
                    <h4>âŒ ë½ ì—†ì„ ë•Œ</h4>
                    <pre><code>[ê³ ë£¨í‹´ A]
count = votes.count  // 0 ì½ìŒ
count = count + 1
votes.count = 1

[ê³ ë£¨í‹´ B]
count = votes.count  // 0 ì½ìŒ!
count = count + 1
votes.count = 1      // ë®ì–´ì”€!

ê²°ê³¼: 2ê°œ ì¶”ê°€í–ˆëŠ”ë° countëŠ” 1</code></pre>
                </div>

                <div class="comparison-item">
                    <h4>âœ… ë½ ìˆì„ ë•Œ</h4>
                    <pre><code>[ê³ ë£¨í‹´ A]
Lock() ğŸ”’
count = votes.count  // 0
count = count + 1
votes.count = 1
Unlock() ğŸ”“

[ê³ ë£¨í‹´ B] (ëŒ€ê¸° ì¤‘...)
Lock() ğŸ”’
count = votes.count  // 1
count = count + 1
votes.count = 2
Unlock() ğŸ”“

ê²°ê³¼: ì •í™•íˆ 2</code></pre>
                </div>
            </div>

            <h4>ì‹¤ì œ ì½”ë“œì—ì„œ ë½ ì‚¬ìš©</h4>

            <pre><code>func (cs *State) handleMsg(mi msgInfo) {
    cs.mtx.Lock()         // ğŸ”’ ë½ ê±¸ê¸°
    defer cs.mtx.Unlock() // ğŸ”“ í•¨ìˆ˜ ëë‚  ë•Œ ìë™ í•´ì œ

    // ì´ ì•ˆì—ì„œëŠ” í˜¼ìë§Œ State ìˆ˜ì • ê°€ëŠ¥!
    cs.Votes.AddVote(vote)
    cs.Height = 101
    cs.Step = Prevote
}</code></pre>
        </section>

        <!-- 3. ì»¨ì„¼ì„œìŠ¤ íë¦„ -->
        <section id="consensus-flow">
            <h2>3. <span class="emoji">ğŸ”„</span> ì»¨ì„¼ì„œìŠ¤ íë¦„</h2>

            <div class="diagram">
ì»¨ì„¼ì„œìŠ¤ ë‹¨ê³„ ì „í™˜:

NewHeight â†’ Propose â†’ Prevote â†’ Precommit â†’ Commit â†’ NewHeight (ë°˜ë³µ)

ê° ë‹¨ê³„ë³„ ì—­í• :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ë‹¨ê³„      â”‚  í•˜ëŠ” ì¼                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Propose    â”‚ í”„ë¡œí¬ì €ê°€ ë¸”ë¡ ì œì•ˆ              â”‚
â”‚ Prevote    â”‚ ë¸”ë¡ ê²€ì¦ í›„ 1ì°¨ íˆ¬í‘œ             â”‚
â”‚ Precommit  â”‚ Prevote ê²°ê³¼ ë³´ê³  2ì°¨ íˆ¬í‘œ        â”‚
â”‚ Commit     â”‚ ë¸”ë¡ ì‹¤í–‰ & ì €ì¥                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>

            <h3 id="receive-routine">receiveRoutine - ë©”ì¸ ì´ë²¤íŠ¸ ë£¨í”„</h3>

            <p>ì»¨ì„¼ì„œìŠ¤ì˜ ì‹¬ì¥ë¶€ë¡œ, ë¬´í•œ ë£¨í”„ë¥¼ ëŒë©´ì„œ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.</p>

            <pre><code>func (cs *State) receiveRoutine(maxSteps int) {
    for {
        rs := cs.RoundState
        var mi msgInfo

        select {
        case &lt;-cs.txNotifier.TxsAvailable():
            // íŠ¸ëœì­ì…˜ ì‚¬ìš© ê°€ëŠ¥
            cs.handleTxsAvailable()

        case mi = &lt;-cs.peerMsgQueue:
            // P2Pì—ì„œ ë©”ì‹œì§€ ë°›ìŒ
            cs.wal.Write(mi)        // WALì— ê¸°ë¡
            cs.handleMsg(mi)        // ì²˜ë¦¬

        case mi = &lt;-cs.internalMsgQueue:
            // ë‚´ë¶€ ë©”ì‹œì§€ (ìì‹ ì˜ íˆ¬í‘œ ë“±)
            cs.wal.WriteSync(mi)    // WALì— ê¸°ë¡ (fsync!)
            cs.handleMsg(mi)

        case ti := &lt;-cs.timeoutTicker.Chan():
            // íƒ€ì„ì•„ì›ƒ ë°œìƒ
            cs.wal.Write(ti)
            cs.handleTimeout(ti, rs)

        case &lt;-cs.Quit():
            // ì¢…ë£Œ
            return
        }
    }
}</code></pre>

            <div class="flow-box">
                <h4>ë©”ì‹œì§€ íë¦„</h4>
                <div class="diagram">
ë‹¤ë¥¸ ë…¸ë“œë“¤ â†’ [peerMsgQueue] â”€â”
                              â”‚
ë‚´ë¶€ ìƒì„±   â†’ [internalMsgQueue] â”€â”¼â†’ receiveRoutine â†’ handleMsg
                              â”‚
íƒ€ì´ë¨¸      â†’ [timeoutTicker] â”€â”˜
                </div>
            </div>

            <h3 id="vote-processing">íˆ¬í‘œ ì²˜ë¦¬</h3>

            <p>íˆ¬í‘œê°€ ë“¤ì–´ì˜¤ë©´ <code>tryAddVote</code> â†’ <code>addVote</code> ìˆœìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>

            <pre><code>func (cs *State) addVote(vote *types.Vote, peerID p2p.ID) (bool, error) {
    // 1. ë†’ì´ ì²´í¬
    if vote.Height != cs.Height {
        return false, nil
    }

    // 2. VoteSetì— ì¶”ê°€
    added, err = cs.Votes.AddVote(vote, peerID, extEnabled)

    // 3. íˆ¬í‘œ íƒ€ì…ë³„ ì²˜ë¦¬
    switch vote.Type {
    case cmtproto.PrevoteType:
        prevotes := cs.Votes.Prevotes(vote.Round)

        // 2/3 ë‹¬ì„±?
        if blockID, ok := prevotes.TwoThirdsMajority(); ok {
            // Lock ì²´í¬ ë° ì—…ë°ì´íŠ¸
            // ...

            // ë‹¤ìŒ ë‹¨ê³„ë¡œ!
            cs.enterPrecommit(height, vote.Round)
        }

    case cmtproto.PrecommitType:
        precommits := cs.Votes.Precommits(vote.Round)

        if blockID, ok := precommits.TwoThirdsMajority(); ok {
            if len(blockID.Hash) != 0 {
                // ë¸”ë¡ í•´ì‹œ ìˆìŒ â†’ ì»¤ë°‹!
                cs.enterCommit(height, vote.Round)
            }
        }
    }

    return added, nil
}</code></pre>

            <div class="success">
                <h4>2/3 ê·œì¹™</h4>
                <p>Byzantine ë…¸ë“œê°€ 1/3 ë¯¸ë§Œì´ë©´ ì‹œìŠ¤í…œì´ ì•ˆì „í•©ë‹ˆë‹¤.</p>
                <p>ì •ì§í•œ ë…¸ë“œê°€ 2/3 ì´ìƒ í•©ì˜í•˜ë©´ ë¸”ë¡ì´ í™•ì •ë©ë‹ˆë‹¤.</p>
            </div>

            <h3 id="consensus-steps">ì»¨ì„¼ì„œìŠ¤ ë‹¨ê³„ë“¤</h3>

            <h4>1. enterPropose - ë¸”ë¡ ì œì•ˆ</h4>

            <pre><code>func (cs *State) enterPropose(height int64, round int32) {
    // íƒ€ì„ì•„ì›ƒ ì„¤ì •
    cs.scheduleTimeout(cs.config.Propose(round), ...)

    // ë‚´ê°€ í”„ë¡œí¬ì €?
    if cs.isProposer(address) {
        // ë¸”ë¡ ë§Œë“¤ê¸°
        cs.decideProposal(height, round)
    }

    // ë¸”ë¡ ì œì•ˆ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ Prevoteë¡œ
    if cs.isProposalComplete() {
        cs.enterPrevote(height, cs.Round)
    }
}</code></pre>

            <h4>2. enterPrevote - 1ì°¨ íˆ¬í‘œ</h4>

            <pre><code>func (cs *State) defaultDoPrevote(height, round) {
    // Lock ê±¸ë¦° ë¸”ë¡ ìˆì–´?
    if cs.LockedBlock != nil {
        cs.signAddVote(PrevoteType, cs.LockedBlock.Hash())
        return
    }

    // ì œì•ˆëœ ë¸”ë¡ ì—†ì–´?
    if cs.ProposalBlock == nil {
        cs.signAddVote(PrevoteType, nil)
        return
    }

    // ë¸”ë¡ ê²€ì¦
    err := cs.blockExec.ValidateBlock(cs.state, cs.ProposalBlock)
    if err != nil {
        cs.signAddVote(PrevoteType, nil)
        return
    }

    // ì• í”Œë¦¬ì¼€ì´ì…˜ ê²€ì¦
    isAppValid := cs.blockExec.ProcessProposal(cs.ProposalBlock, cs.state)
    if !isAppValid {
        cs.signAddVote(PrevoteType, nil)
        return
    }

    // ëª¨ë“  ê²€ì¦ í†µê³¼! â†’ ì°¬ì„±
    cs.signAddVote(PrevoteType, cs.ProposalBlock.Hash())
}</code></pre>

            <h4>3. enterPrecommit - 2ì°¨ íˆ¬í‘œ</h4>

            <pre><code>func (cs *State) enterPrecommit(height, round) {
    // Prevote ê²°ê³¼ í™•ì¸
    blockID, ok := cs.Votes.Prevotes(round).TwoThirdsMajority()

    if !ok {
        // 2/3 ì—†ìŒ â†’ nil Precommit
        cs.signAddVote(PrecommitType, nil)
        return
    }

    if len(blockID.Hash) == 0 {
        // 2/3ê°€ nil â†’ Lock í•´ì œ
        cs.LockedBlock = nil
        cs.signAddVote(PrecommitType, nil)
        return
    }

    // 2/3ê°€ íŠ¹ì • ë¸”ë¡ ì„ íƒ!
    if cs.ProposalBlock.HashesTo(blockID.Hash) {
        // Lock ê±¸ê¸°!
        cs.LockedRound = round
        cs.LockedBlock = cs.ProposalBlock

        cs.signAddVote(PrecommitType, blockID.Hash)
    }
}</code></pre>

            <h4>4. finalizeCommit - ë¸”ë¡ ì‹¤í–‰</h4>

            <pre><code>func (cs *State) finalizeCommit(height) {
    // 1. ë¸”ë¡ ì €ì¥
    cs.blockStore.SaveBlock(block, blockParts, seenExtendedCommit)

    // 2. WALì— EndHeight ê¸°ë¡
    cs.wal.WriteSync(EndHeightMessage{height})

    // 3. ë¸”ë¡ ì‹¤í–‰!
    stateCopy, err := cs.blockExec.ApplyVerifiedBlock(
        stateCopy, blockID, block,
    )

    // 4. State ì—…ë°ì´íŠ¸
    cs.updateToState(stateCopy)
    // Height + 1, Round = 0, Votes ì´ˆê¸°í™”

    // 5. ë‹¤ìŒ ë¼ìš´ë“œ ì‹œì‘
    cs.scheduleRound0(&cs.RoundState)
}</code></pre>

            <div class="flow-box">
                <h4>ì •ìƒ ì¼€ì´ìŠ¤ íë¦„</h4>
                <div class="diagram">
Height 100, Round 0

[Propose]
  í”„ë¡œí¬ì €: "Block A ì œì•ˆ!"
    â†“
[Prevote]
  67% ì°¬ì„± â†’ Block Aì— Prevote
  (2/3 ë‹¬ì„±!)
    â†“
[Precommit]
  67%ê°€ Block Aì— Lock & Precommit
  (2/3 ë‹¬ì„±!)
    â†“
[Commit]
  Block A ì‹¤í–‰ â†’ ë””ìŠ¤í¬ ì €ì¥ â†’ Height 101ë¡œ
                </div>
            </div>
        </section>

        <!-- 4. ë¸”ë¡ ì¡°ê°ê³¼ P2P -->
        <section id="block-parts">
            <h2>4. <span class="emoji">ğŸ§©</span> ë¸”ë¡ ì¡°ê°ê³¼ P2P</h2>

            <h3 id="partset">ë¸”ë¡ ì¡°ê° (PartSet)</h3>

            <p>í° ë¸”ë¡ì„ ì‘ì€ ì¡°ê°ìœ¼ë¡œ ë‚˜ëˆ ì„œ ì „ì†¡í•©ë‹ˆë‹¤. ë³´í†µ 64KBì”© ë‚˜ëˆ•ë‹ˆë‹¤.</p>

            <pre><code>func NewPartSetFromData(data []byte, partSize uint32) *PartSet {
    // 1. ì´ ì¡°ê° ê°œìˆ˜ ê³„ì‚°
    total := (uint32(len(data)) + partSize - 1) / partSize

    // 2. ê° ì¡°ê° ë§Œë“¤ê¸°
    parts := make([]*Part, total)
    for i := uint32(0); i < total; i++ {
        part := &Part{
            Index: i,
            Bytes: data[i*partSize : min(len(data), (i+1)*partSize)],
        }
        parts[i] = part
    }

    // 3. Merkle Proof ìƒì„±
    root, proofs := merkle.ProofsFromByteSlices(partsBytes)
    for i := 0; i < total; i++ {
        parts[i].Proof = *proofs[i]
    }

    return &PartSet{
        total: total,
        hash:  root,
        parts: parts,
    }
}</code></pre>

            <div class="diagram">
ë¸”ë¡ ì¡°ê° ë‚˜ëˆ„ê¸°:

ë¸”ë¡ (100 KB)
   â†“
Proto ì§ë ¬í™” â†’ ë°”ì´íŠ¸ ë°°ì—´ [0...100,000]
   â†“
partSize = 64 KBë¡œ ë‚˜ëˆ„ê¸°
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Part 0: bytes[0...64,000]           â”‚
â”‚        + Merkle Proof               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Part 1: bytes[64,000...100,000]     â”‚
â”‚        + Merkle Proof               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
PartSet {
  total: 2
  hash: Merkle Root
  parts: [Part0, Part1]
}
            </div>

            <div class="note">
                <h4>ì™œ ì¡°ê°ìœ¼ë¡œ ë‚˜ëˆŒê¹Œ?</h4>
                <ul>
                    <li><strong>ë³‘ë ¬ ì „ì†¡</strong>: ì—¬ëŸ¬ ì¡°ê°ì„ ë™ì‹œì— ë°›ì„ ìˆ˜ ìˆìŒ</li>
                    <li><strong>ë„¤íŠ¸ì›Œí¬ íš¨ìœ¨</strong>: í° ë¸”ë¡ì„ í•œ ë²ˆì— ë³´ë‚´ë©´ ë¶€ë‹´</li>
                    <li><strong>ê²€ì¦ ê°€ëŠ¥</strong>: Merkle proofë¡œ ê° ì¡°ê° ê²€ì¦</li>
                </ul>
            </div>

            <h3 id="p2p-concurrency">P2P ë™ì‹œì„±</h3>

            <p>ê° í”¼ì–´ë§ˆë‹¤ 2ê°œì˜ ê³ ë£¨í‹´ì´ ë™ì‘í•©ë‹ˆë‹¤.</p>

            <div class="diagram">
CometBFT Node
   â†“
Switch (P2P ë§¤ë‹ˆì €)
   â†“
â”œâ”€ Peer 1 (ê³ ë£¨í‹´ 2ê°œ)
â”‚   â”œâ”€ sendRoutine (ê³ ë£¨í‹´) â†’ ë©”ì‹œì§€ ì „ì†¡
â”‚   â””â”€ recvRoutine (ê³ ë£¨í‹´) â†’ ë©”ì‹œì§€ ìˆ˜ì‹ 
â”‚
â”œâ”€ Peer 2 (ê³ ë£¨í‹´ 2ê°œ)
â”‚   â”œâ”€ sendRoutine (ê³ ë£¨í‹´)
â”‚   â””â”€ recvRoutine (ê³ ë£¨í‹´)
â”‚
â”œâ”€ Peer 3 (ê³ ë£¨í‹´ 2ê°œ)
   ...

ì´ Nê°œ í”¼ì–´ â†’ 2Nê°œ ê³ ë£¨í‹´!
            </div>

            <pre><code>func (c *MConnection) OnStart() error {
    // ğŸ”¥ ê° ì—°ê²°ë§ˆë‹¤ 2ê°œ ê³ ë£¨í‹´ ì‹œì‘!
    go c.sendRoutine()  // ì†¡ì‹  ê³ ë£¨í‹´
    go c.recvRoutine()  // ìˆ˜ì‹  ê³ ë£¨í‹´

    return nil
}</code></pre>

            <div class="success">
                <h4>ë¸”ë¡ ì¡°ê° ì „ì†¡ ì˜ˆì‹œ</h4>
                <p>100ê°œ í”¼ì–´ì™€ ì—°ê²°ë˜ì–´ ìˆë‹¤ë©´:</p>
                <ul>
                    <li>200ê°œ ê³ ë£¨í‹´ì´ ë™ì‹œ ì‹¤í–‰</li>
                    <li>ê° í”¼ì–´ì—ê²Œ ë¸”ë¡ ì¡°ê°ì„ ë³‘ë ¬ë¡œ ì „ì†¡</li>
                    <li>ë¹ ë¥¸ ë¸”ë¡ ì „íŒŒ!</li>
                </ul>
            </div>
        </section>

        <!-- 5. ABCI -->
        <section id="abci">
            <h2>5. <span class="emoji">ğŸ”Œ</span> ABCI ì¸í„°í˜ì´ìŠ¤</h2>

            <p>ABCIëŠ” CometBFT(ì»¨ì„¼ì„œìŠ¤)ì™€ Application(ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)ì„ ì—°ê²°í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.</p>

            <div class="diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        CometBFT (ì»¨ì„¼ì„œìŠ¤)              â”‚
â”‚    ë¸”ë¡ ìˆœì„œë§Œ ê²°ì •                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ ABCI
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Application (ì• í”Œë¦¬ì¼€ì´ì…˜)         â”‚
â”‚   ê²°ì œ ë¡œì§, ì”ì•¡ ê´€ë¦¬, ê²€ì¦            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>

            <h3 id="abci-methods">ì£¼ìš” ABCI ë©”ì„œë“œ</h3>

            <table>
                <thead>
                    <tr>
                        <th>ë©”ì„œë“œ</th>
                        <th>í˜¸ì¶œ ì‹œì </th>
                        <th>ì—­í• </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>CheckTx</code></td>
                        <td>Mempool ì§„ì…</td>
                        <td>íŠ¸ëœì­ì…˜ ê¸°ë³¸ ê²€ì¦</td>
                    </tr>
                    <tr>
                        <td><code>PrepareProposal</code></td>
                        <td>ë¸”ë¡ ì œì•ˆ ì „</td>
                        <td>íŠ¸ëœì­ì…˜ ì¬ì •ë ¬/ìˆ˜ì •</td>
                    </tr>
                    <tr>
                        <td><code>ProcessProposal</code></td>
                        <td>Prevote ì „</td>
                        <td>ë¸”ë¡ ì œì•ˆ ê²€ì¦ (Accept/Reject)</td>
                    </tr>
                    <tr>
                        <td><code>FinalizeBlock</code></td>
                        <td>Commit ë‹¨ê³„</td>
                        <td>ë¸”ë¡ ì‹¤í–‰ (íŠ¸ëœì­ì…˜ ì²˜ë¦¬)</td>
                    </tr>
                    <tr>
                        <td><code>Commit</code></td>
                        <td>ì‹¤í–‰ í›„</td>
                        <td>ìƒíƒœ ë””ìŠ¤í¬ì— ì €ì¥</td>
                    </tr>
                </tbody>
            </table>

            <h3 id="execution">ë¸”ë¡ ì‹¤í–‰ ê³¼ì •</h3>

            <div class="flow-box">
                <h4>ABCI ì „ì²´ íë¦„</h4>
                <div class="diagram">
[Mempool]
íŠ¸ëœì­ì…˜ ë“¤ì–´ì˜´
   â†“
CheckTx (ABCI) â†’ ì„œëª…/ì”ì•¡ ê²€ì¦
   â†“
Mempoolì— ì¶”ê°€
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[Propose]
CreateProposalBlock
   â†“
PrepareProposal (ABCI) â†’ íŠ¸ëœì­ì…˜ ì¬ì •ë ¬
   â†“
ë¸”ë¡ ì œì•ˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[Prevote]
ë¸”ë¡ ì œì•ˆ ë°›ìŒ
   â†“
ProcessProposal (ABCI) â†’ Accept or Reject
   â†“
íˆ¬í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[Commit]
2/3 í•©ì˜ ì™„ë£Œ
   â†“
FinalizeBlock (ABCI) â†’ íŠ¸ëœì­ì…˜ ì‹¤í–‰
   â†“
Commit (ABCI) â†’ ìƒíƒœ ì €ì¥
   â†“
Height + 1
                </div>
            </div>

            <h4>ê²°ì œ ì²´ì¸ ì˜ˆì œ: FinalizeBlock êµ¬í˜„</h4>

            <pre><code>func (app *PaymentApp) FinalizeBlock(req *RequestFinalizeBlock) (*ResponseFinalizeBlock, error) {
    txResults := []*ExecTxResult{}

    for _, txBytes := range req.Txs {
        tx := DecodeTx(txBytes)

        // íŠ¸ëœì­ì…˜ ì‹¤í–‰
        if app.GetBalance(tx.From) >= tx.Amount + tx.Fee {
            // ì„±ê³µ
            app.Transfer(tx.From, tx.To, tx.Amount)
            app.Transfer(tx.From, req.ProposerAddress, tx.Fee)

            txResults = append(txResults, &ExecTxResult{
                Code: 0,
                Log: "success",
            })
        } else {
            // ì‹¤íŒ¨
            txResults = append(txResults, &ExecTxResult{
                Code: 1,
                Log: "insufficient balance",
            })
        }
    }

    // ìƒˆ ìƒíƒœ í•´ì‹œ
    appHash := app.state.ComputeMerkleRoot()

    return &ResponseFinalizeBlock{
        TxResults: txResults,
        AppHash:   appHash,
    }, nil
}</code></pre>

            <div class="warning">
                <h4>ì¤‘ìš”: ê²°ì •ë¡ ì  ì‹¤í–‰</h4>
                <p>ëª¨ë“  ë…¸ë“œê°€ ê°™ì€ ë¸”ë¡ì„ ì‹¤í–‰í•˜ë©´ <strong>ê°™ì€ ê²°ê³¼</strong>ê°€ ë‚˜ì™€ì•¼ í•©ë‹ˆë‹¤!</p>
                <ul>
                    <li>âŒ <code>time.Now()</code> ì‚¬ìš© ê¸ˆì§€ â†’ ë¸”ë¡ ì‹œê°„ ì‚¬ìš©</li>
                    <li>âŒ ë§µ ìˆœíšŒ ê¸ˆì§€ â†’ ì •ë ¬ í›„ ìˆœíšŒ</li>
                    <li>âœ… ëª¨ë“  ì—°ì‚°ì´ ê²°ì •ë¡ ì ì´ì–´ì•¼ í•¨</li>
                </ul>
            </div>

            <h4>ê° ë…¸ë“œê°€ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰</h4>

            <div class="comparison">
                <div class="comparison-item">
                    <h4>Node A</h4>
                    <pre><code>// Height 100 ì‹¤í–‰
Tx1: Aliceâ†’Bob 100ì›
  Alice: 900ì›
  Bob: 600ì›

AppHash: 0x1234ABCD...</code></pre>
                </div>

                <div class="comparison-item">
                    <h4>Node B</h4>
                    <pre><code>// Height 100 ì‹¤í–‰ (ë™ì¼!)
Tx1: Aliceâ†’Bob 100ì›
  Alice: 900ì›
  Bob: 600ì›

AppHash: 0x1234ABCD... âœ…</code></pre>
                </div>
            </div>

            <p class="highlight">ëª¨ë“  ë…¸ë“œê°€ ê°™ì€ AppHashë¥¼ ê³„ì‚°í•˜ë©´ ìƒíƒœ ì¼ì¹˜ê°€ ë³´ì¥ë©ë‹ˆë‹¤!</p>
        </section>

        <!-- 6. Mempool -->
        <section id="mempool">
            <h2>6. <span class="emoji">ğŸ—„ï¸</span> Mempool</h2>

            <p>Mempoolì€ ë¸”ë¡ì— í¬í•¨ë˜ê¸° ì „ íŠ¸ëœì­ì…˜ì´ ëŒ€ê¸°í•˜ëŠ” ê³³ì…ë‹ˆë‹¤.</p>

            <h3 id="mempool-structure">êµ¬ì¡°ì™€ ë™ì‘</h3>

            <div class="diagram">
Mempool = í¸ì˜ì  ì§„ì—´ëŒ€
íŠ¸ëœì­ì…˜ = ìƒí’ˆ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            Mempool
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[Tx1: Aliceâ†’Bob 100ì›]
[Tx2: Carolâ†’Dave 50ì›]
[Tx3: Eveâ†’Frank 200ì›]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

êµ¬ì¡°:
- ì—°ê²° ë¦¬ìŠ¤íŠ¸ (txs): ìˆœì„œ ìœ ì§€ (FIFO)
- ë§µ (txsMap): ë¹ ë¥¸ ê²€ìƒ‰ (O(1))
- ìºì‹œ: ì¤‘ë³µ ë°©ì§€
            </div>

            <h4>Mempool 3ë‹¨ê³„</h4>

            <div class="flow-box">
                <h4>1. CheckTx - íŠ¸ëœì­ì…˜ ê²€ì¦ í›„ ì¶”ê°€</h4>
                <pre><code>íŠ¸ëœì­ì…˜ ë„ì°©
   â†“
í¬ê¸° ì²´í¬ (ë„ˆë¬´ í¬ë©´ ê±°ë¶€)
   â†“
ìºì‹œ ì²´í¬ (ì´ë¯¸ ë´¤ìœ¼ë©´ ê±°ë¶€)
   â†“
ABCI CheckTx (ì• í”Œë¦¬ì¼€ì´ì…˜ ê²€ì¦)
   â†“
OK â†’ Mempoolì— ì¶”ê°€</code></pre>
            </div>

            <div class="flow-box">
                <h4>2. ReapMaxBytesMaxGas - ë¸”ë¡ ë§Œë“¤ ë•Œ ê°€ì ¸ê°€ê¸°</h4>
                <pre><code>ë¸”ë¡ ì œì•ˆ ì‹œê°„!
   â†“
ì œí•œ: ìµœëŒ€ í¬ê¸° 1MB, ìµœëŒ€ Gas 10M
   â†“
Mempool ìˆœíšŒ (ë¨¼ì € ë“¤ì–´ì˜¨ ìˆœ):
Tx1 (100KB, Gas 1000) â†’ ì¶”ê°€ âœ…
Tx2 (200KB, Gas 2000) â†’ ì¶”ê°€ âœ…
Tx3 (800KB, Gas 5000) â†’ ì œì™¸ âŒ (í¬ê¸° ì´ˆê³¼)
   â†“
ë°˜í™˜: [Tx1, Tx2]</code></pre>
            </div>

            <div class="flow-box">
                <h4>3. Update - ë¸”ë¡ ì‹¤í–‰ í›„ ì œê±°</h4>
                <pre><code>ë¸”ë¡ ì‹¤í–‰ ì™„ë£Œ
   â†“
Tx1: ì„±ê³µ âœ… â†’ Mempoolì—ì„œ ì œê±°
Tx2: ì„±ê³µ âœ… â†’ Mempoolì—ì„œ ì œê±°
Tx3: ì‹¤íŒ¨ âŒ â†’ Mempoolì— ìœ ì§€ (ì¬ì‹œë„)
   â†“
Mempool ì—…ë°ì´íŠ¸</code></pre>
            </div>

            <h3 id="mempool-optimization">ê²°ì œ ì²´ì¸ ìµœì í™”</h3>

            <div class="warning">
                <h4>ë¬¸ì œ: FIFOëŠ” ìˆ˜ìˆ˜ë£Œ ìš°ì„ ìˆœìœ„ê°€ ì—†ìŒ!</h4>
                <pre><code>í˜„ì¬ Mempool (FIFO):
[ìˆ˜ìˆ˜ë£Œ 1ì›] â†’ [ìˆ˜ìˆ˜ë£Œ 100ì›] â†’ [ìˆ˜ìˆ˜ë£Œ 10ì›]
     â†‘
  ë¨¼ì € ì²˜ë¦¬ë¨ (ë¶ˆê³µí‰!)</code></pre>
            </div>

            <div class="success">
                <h4>í•´ê²°ì±… 1: PrepareProposalì—ì„œ ì •ë ¬</h4>
                <pre><code>func (app *PaymentApp) PrepareProposal(req *RequestPrepareProposal) {
    txs := req.Txs

    // ìˆ˜ìˆ˜ë£Œë¡œ ì •ë ¬!
    sort.Slice(txs, func(i, j int) bool {
        feeI := ExtractFee(txs[i])
        feeJ := ExtractFee(txs[j])
        return feeI > feeJ  // ë†’ì€ ìˆ˜ìˆ˜ë£Œ ë¨¼ì €
    })

    return &ResponsePrepareProposal{Txs: txs}, nil
}</code></pre>
            </div>

            <div class="success">
                <h4>í•´ê²°ì±… 2: Priority Mempool êµ¬í˜„</h4>
                <pre><code>type PriorityMempool struct {
    txs *PriorityQueue  // ìš°ì„ ìˆœìœ„ í (í™)
    // ìˆ˜ìˆ˜ë£Œ ë†’ì€ ê²Œ ë¨¼ì € ë‚˜ì˜´
}

func (mem *PriorityMempool) ReapMaxBytesMaxGas(...) {
    for mem.txs.Len() > 0 {
        memTx := mem.txs.Pop()  // ìµœê³  ìˆ˜ìˆ˜ë£Œ
        // ...
    }
}</code></pre>
            </div>
        </section>

        <!-- 7. ì •ë¦¬ -->
        <section id="summary">
            <h2>7. <span class="emoji">ğŸ“Š</span> ì •ë¦¬ ë° ê²°ë¡ </h2>

            <h3>í•µì‹¬ ì»´í¬ë„ŒíŠ¸ ìš”ì•½</h3>

            <table>
                <thead>
                    <tr>
                        <th>ì»´í¬ë„ŒíŠ¸</th>
                        <th>ì—­í• </th>
                        <th>í•µì‹¬ í¬ì¸íŠ¸</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>State</strong></td>
                        <td>ì»¨ì„¼ì„œìŠ¤ ìƒíƒœ ê´€ë¦¬</td>
                        <td>Lockìœ¼ë¡œ ë™ì‹œì„± ì œì–´</td>
                    </tr>
                    <tr>
                        <td><strong>receiveRoutine</strong></td>
                        <td>ë©”ì¸ ì´ë²¤íŠ¸ ë£¨í”„</td>
                        <td>3ê°œ ì±„ë„ ê°ì‹œ (peer, internal, timeout)</td>
                    </tr>
                    <tr>
                        <td><strong>Consensus Steps</strong></td>
                        <td>ë‹¨ê³„ë³„ í•©ì˜ ì§„í–‰</td>
                        <td>Propose â†’ Prevote â†’ Precommit â†’ Commit</td>
                    </tr>
                    <tr>
                        <td><strong>PartSet</strong></td>
                        <td>ë¸”ë¡ ì¡°ê°í™”</td>
                        <td>64KBì”© ë‚˜ëˆ ì„œ ë³‘ë ¬ ì „ì†¡</td>
                    </tr>
                    <tr>
                        <td><strong>P2P</strong></td>
                        <td>ë„¤íŠ¸ì›Œí¬ í†µì‹ </td>
                        <td>ê° í”¼ì–´ë‹¹ 2ê°œ ê³ ë£¨í‹´ (send/recv)</td>
                    </tr>
                    <tr>
                        <td><strong>ABCI</strong></td>
                        <td>ì•± ì—°ê²°</td>
                        <td>ì»¨ì„¼ì„œìŠ¤ â†” ì• í”Œë¦¬ì¼€ì´ì…˜ ë¶„ë¦¬</td>
                    </tr>
                    <tr>
                        <td><strong>Mempool</strong></td>
                        <td>íŠ¸ëœì­ì…˜ ëŒ€ê¸°ì‹¤</td>
                        <td>CheckTx â†’ Reap â†’ Update</td>
                    </tr>
                </tbody>
            </table>

            <h3>ì»¨ì„¼ì„œìŠ¤ ì „ì²´ íë¦„</h3>

            <div class="diagram">
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Height N, Round 0
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Propose
   í”„ë¡œí¬ì €ê°€ ë¸”ë¡ ì œì•ˆ
   - Mempoolì—ì„œ íŠ¸ëœì­ì…˜ ê°€ì ¸ì˜¤ê¸°
   - PrepareProposal (ABCI)
   - ë¸”ë¡ ì¡°ê°ìœ¼ë¡œ ë‚˜ëˆ ì„œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
   â†“

2. Prevote (1ì°¨ íˆ¬í‘œ)
   ê° ê²€ì¦ìê°€ ë¸”ë¡ ê²€ì¦
   - ProcessProposal (ABCI) - Accept/Reject
   - ValidateBlock
   - íˆ¬í‘œ: ë¸”ë¡ or nil
   â†“

3. 2/3 Prevote ìˆ˜ì§‘
   íˆ¬í‘œ ì§‘ê³„
   - 2/3 ì´ìƒ ê°™ì€ ë¸”ë¡ â†’ Lock ê±¸ê³  ë‹¤ìŒ ë‹¨ê³„
   - 2/3 ì—†ìŒ â†’ PrevoteWait (íƒ€ì„ì•„ì›ƒ ëŒ€ê¸°)
   â†“

4. Precommit (2ì°¨ íˆ¬í‘œ)
   Prevote ê²°ê³¼ ê¸°ë°˜ íˆ¬í‘œ
   - 2/3ê°€ ì„ íƒí•œ ë¸”ë¡ì— Precommit
   - Lock ì—…ë°ì´íŠ¸
   â†“

5. 2/3 Precommit ìˆ˜ì§‘
   ìµœì¢… í•©ì˜
   - 2/3 ì´ìƒ â†’ Commit!
   - 2/3 ì—†ìŒ â†’ ë‹¤ìŒ Round
   â†“

6. Commit
   ë¸”ë¡ ì‹¤í–‰ ë° ì €ì¥
   - FinalizeBlock (ABCI) - íŠ¸ëœì­ì…˜ ì‹¤í–‰
   - Commit (ABCI) - ìƒíƒœ ì €ì¥
   - Height + 1
   â†“

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Height N+1, Round 0 (ë°˜ë³µ)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            </div>

            <h3>ê²°ì œ ì²´ì¸ êµ¬í˜„ ì‹œ ê³ ë ¤ì‚¬í•­</h3>

            <div class="key-point">
                <h4>CometBFT ë ˆì´ì–´ì—ì„œ</h4>
                <ul>
                    <li><strong>ë¸”ë¡ íƒ€ì„ ì¡°ì •</strong>: Propose timeout ì¤„ì´ê¸°</li>
                    <li><strong>Mempool ìš°ì„ ìˆœìœ„</strong>: ìˆ˜ìˆ˜ë£Œ ê¸°ë°˜ ì •ë ¬</li>
                    <li><strong>ë„¤íŠ¸ì›Œí¬ ìµœì í™”</strong>: í”¼ì–´ ì—°ê²° ìˆ˜ ì¡°ì •</li>
                </ul>
            </div>

            <div class="key-point">
                <h4>ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆì´ì–´ì—ì„œ</h4>
                <ul>
                    <li><strong>CheckTx</strong>: ë¹ ë¥¸ ê¸°ë³¸ ê²€ì¦ (ì„œëª…, nonce, ì”ì•¡)</li>
                    <li><strong>PrepareProposal</strong>: ìˆ˜ìˆ˜ë£Œ ë†’ì€ ìˆœ ì •ë ¬</li>
                    <li><strong>ProcessProposal</strong>: ë¸”ë¡ ì „ì²´ ê²€ì¦</li>
                    <li><strong>FinalizeBlock</strong>: ê²°ì •ë¡ ì  ì‹¤í–‰ ë³´ì¥</li>
                    <li><strong>ìˆ˜ìˆ˜ë£Œ ë¶„ë°°</strong>: ê²€ì¦ì/ì¬ë¬´ë¶€ë¡œ ë¶„ë°°</li>
                </ul>
            </div>

            <h3>ì£¼ìš” ê°œë… ì •ë¦¬</h3>

            <div class="comparison">
                <div class="comparison-item">
                    <h4>í•©ì˜ (Consensus)</h4>
                    <ul>
                        <li>ë¸”ë¡ <strong>ìˆœì„œ</strong> ê²°ì •</li>
                        <li>ë„¤íŠ¸ì›Œí¬ ì „ì²´ ì°¸ì—¬</li>
                        <li>2/3 í•©ì˜ë¡œ í™•ì •</li>
                    </ul>
                </div>

                <div class="comparison-item">
                    <h4>ì‹¤í–‰ (Execution)</h4>
                    <ul>
                        <li>ë¸”ë¡ <strong>ë‚´ìš©</strong> ì²˜ë¦¬</li>
                        <li>ê° ë…¸ë“œ ë…ë¦½ì  ìˆ˜í–‰</li>
                        <li>ê²°ì •ë¡ ì  ê²°ê³¼ í•„ìˆ˜</li>
                    </ul>
                </div>
            </div>

            <div class="note">
                <h4>ì™œ ì´ë ‡ê²Œ ì„¤ê³„í–ˆì„ê¹Œ?</h4>
                <p><strong>ê´€ì‹¬ì‚¬ì˜ ë¶„ë¦¬ (Separation of Concerns)</strong></p>
                <ul>
                    <li><strong>CometBFT</strong>: ìˆœì„œ í•©ì˜ì—ë§Œ ì§‘ì¤‘ (ì–´ë–¤ ì•±ì´ë“  ì‚¬ìš© ê°€ëŠ¥)</li>
                    <li><strong>Application</strong>: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ë§Œ ì§‘ì¤‘ (ì»¨ì„¼ì„œìŠ¤ ì‹ ê²½ ì•ˆ ì¨ë„ ë¨)</li>
                    <li><strong>ABCI</strong>: ë‘˜ì„ ê¹”ë”í•˜ê²Œ ë¶„ë¦¬</li>
                </ul>
                <p class="highlight">ê²°ê³¼: ë¹ ë¥¸ ê°œë°œ, ë†’ì€ ì¬ì‚¬ìš©ì„±, ì‰¬ìš´ ìœ ì§€ë³´ìˆ˜!</p>
            </div>

            <h3>ë‹¤ìŒ ë‹¨ê³„</h3>

            <ol>
                <li><strong>ì‹¤ìŠµ</strong>: ê°„ë‹¨í•œ ê²°ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë§Œë“¤ì–´ë³´ê¸°</li>
                <li><strong>ìµœì í™”</strong>: ë¸”ë¡ íƒ€ì„, throughput ê°œì„ </li>
                <li><strong>ëª¨ë‹ˆí„°ë§</strong>: Metrics, ë¡œê·¸ ë¶„ì„</li>
                <li><strong>í…ŒìŠ¤íŠ¸</strong>: ë„¤íŠ¸ì›Œí¬ ì¥ì• , Byzantine ë…¸ë“œ ì‹œë®¬ë ˆì´ì…˜</li>
            </ol>

            <div class="success">
                <h4>ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</h4>
                <p>CometBFT ì»¨ì„¼ì„œìŠ¤ì˜ í•µì‹¬ì„ ëª¨ë‘ ì´í•´í•˜ì…¨ìŠµë‹ˆë‹¤!</p>
                <p>ì´ì œ Cosmos ê¸°ë°˜ L1 ê²°ì œ ì²´ì¸ì„ ë§Œë“¤ ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            </div>
        </section>

        <footer>
            <p>Created with â¤ï¸ for CometBFT Consensus Study</p>
            <p>Last Updated: 2025</p>
        </footer>
    </div>
</body>
</html>