---
order: 4
---

# Upgrading from CometBFT v0.38 to v1.0

This document is intended to provide detailed insights into significant changes that may
require additional information beyond what is covered in the CHANGELOG. It highlights the
changes users must make when migrating from the cometbft `v0.38.x` release line to the
CometBFT `v1.x` and offers comprehensive documentation for these changes.

> **NOTE**: It is essential to emphasize that this is a [major version bump](https://github.com/cometbft/cometbft/blob/main/README.md#versioning)
> upgrade (`v0.38.x` -> `v1.x`). Therefore, a **coordinated upgrade** is necessary. A mixed network with `v0.38.x` and `v1.x` nodes is not supported.

Upgrading from CometBFT `v0.38.x` to `v1.x` involves several important changes, particularly in configuration and functionality.

Hereâ€™s a comprehensive guide to help you with the upgrade process:

## Overview of Changes

CometBFT `v1` introduces several new features, optimizations, and breaking changes.

## Configuration File `config.toml`

Review the `config.toml` file, as several parameters have been added, modified, or deprecated. Review the official
[documentation](https://docs.cometbft.com/v1.0/references/config/config.toml) for `v1` to identify any new fields or
modified data types that need to be included.

### New Parameters:

Check for newly introduced parameters in the CometBFT `v1` configuration file.

You may need to add or modify these to optimize your node's performance or properly run a node.

#### `[consensus]` section:

The `peer_gossip_intraloop_sleep_duration` [has been added](https://github.com/cometbft/cometbft/pull/904).

The default value in `v1` is `"0s"`:

```toml
peer_gossip_intraloop_sleep_duration = "0s"
```

#### `[grpc]` section:

A new `[grpc]` section has been introduced to support all the parameters for the new [Data Companion API services](#data-companion-api)

```toml
#######################################################
###       gRPC Server Configuration Options         ###
#######################################################

#
# Note that the gRPC server is exposed unauthenticated. It is critical that
# this server not be exposed directly to the public internet. If this service
# must be accessed via the public internet, please ensure that appropriate
# precautions are taken (e.g. fronting with a reverse proxy like nginx with TLS
# termination and authentication, using DDoS protection services like
# CloudFlare, etc.).
#

[grpc]

# TCP or UNIX socket address for the RPC server to listen on. If not specified,
# the gRPC server will be disabled.
laddr = ""

#
# Each gRPC service can be turned on/off, and in some cases configured,
# individually. If the gRPC server is not enabled, all individual services'
# configurations are ignored.
#

# The gRPC version service provides version information about the node and the
# protocols it uses.
[grpc.version_service]
enabled = true

# The gRPC block service returns block information
[grpc.block_service]
enabled = true

# The gRPC block results service returns block results for a given height. If no height
# is given, it will return the block results from the latest height.
[grpc.block_results_service]
enabled = true

#
# Configuration for privileged gRPC endpoints, which should **never** be exposed
# to the public internet.
#
[grpc.privileged]
# The host/port on which to expose privileged gRPC endpoints.
laddr = ""

#
# Configuration specifically for the gRPC pruning service, which is considered a
# privileged service.
#
[grpc.privileged.pruning_service]

# Only controls whether the pruning service is accessible via the gRPC API - not
# whether a previously set pruning service retain height is honored by the
# node. See the [storage.pruning] section for control over pruning.
#
# Disabled by default.
enabled = false
```

#### `[storage]` section:

##### Experimental Key Layouts

The `experimental_db_key_layout` [has been added](https://github.com/cometbft/cometbft/pull/2327/).

The default value is `v1`:

```toml
# The representation of keys in the database.
# The current representation of keys in Comet's stores is considered to be v1
# Users can experiment with a different layout by setting this field to v2.
# Note that this is an experimental feature and switching back from v2 to v1
# is not supported by CometBFT.
# If the database was initially created with v1, it is necessary to migrate the DB
# before switching to v2. The migration is not done automatically.
# v1 - the legacy layout existing in Comet prior to v1.
# v2 - Order preserving representation ordering entries by height.
experimental_db_key_layout = "v1"
```

##### Database Compaction

Two new parameters [were added](https://github.com/cometbft/cometbft/issues/49) to support database compaction. The `compact` and the `compaction_interval` can be customized
to allow compaction and how frequent that should be triggered (number of blocks interval).

```toml
# If set to true, CometBFT will force compaction to happen for databases that support this feature.
# and save on storage space. Setting this to true is most benefits when used in combination
# with pruning as it will physically delete the entries marked for deletion.
# false by default (forcing compaction is disabled).
compact = false
```
```toml
# To avoid forcing compaction every time, this parameter instructs CometBFT to wait
# the given amount of blocks to be pruned before triggering compaction.
# It should be tuned depending on the number of items. If your retain height is 1 block,
# it is too much of an overhead to try compaction every block. But it should also not be a very
# large multiple of your retain height as it might occur bigger overheads.
compaction_interval = "1000"
```

##### Pruning

CometBFT `v1` implemented support for a [pruning mechanism](https://github.com/cometbft/cometbft/pull/1150)

A new parameter `interval` was added to control the time period between automated background pruning operations.
```toml
# The time period between automated background pruning operations.
interval = "10s"
```

Other parameters were also introduced to configure the [Data Companion pruning service](https://docs.cometbft.com/v1.0/explanation/data-companion/pruning)

```toml
#
# Storage pruning configuration relating only to the data companion.
#
[storage.pruning.data_companion]

# Whether automatic pruning respects values set by the data companion. Disabled
# by default. All other parameters in this section are ignored when this is
# disabled.
#
# If disabled, only the application retain height will influence block pruning
# (but not block results pruning). Only enabling this at a later stage will
# potentially mean that blocks below the application-set retain height at the
# time will not be available to the data companion.
enabled = false

# The initial value for the data companion block retain height if the data
# companion has not yet explicitly set one. If the data companion has already
# set a block retain height, this is ignored.
initial_block_retain_height = 0

# The initial value for the data companion block results retain height if the
# data companion has not yet explicitly set one. If the data companion has
# already set a block results retain height, this is ignored.
initial_block_results_retain_height = 0
```

### Removed Parameters:

Some parameters have been removed in `v1.x` and are not applicable anymore.

#### `[mempool]` section:

The `max_batch_bytes` [has been removed](https://github.com/cometbft/cometbft/pull/2050).

```toml
max_batch_bytes = 0
```

### Changed Parameters:

Some sections changed their structure or naming conventions. Ensure you adapt your configuration accordingly.

#### `[p2p]` section:

The `flush_throttle_timeout` [default value has been lowered](https://github.com/cometbft/cometbft/issues/2988).

Default configuration in `v0.38.x`:
```toml
# Time to wait before flushing messages out on the connection
flush_throttle_timeout = "100ms"
```
Default configuration in `v1.x`:
```toml
# Time to wait before flushing messages out on the connection
flush_throttle_timeout = "10ms"
```

#### `[mempool]` section:

The `max_txs_bytes` [default value has been lowered](https://github.com/cometbft/cometbft/issues/2756).

Default configuration in `v0.38.x`:
```toml
max_txs_bytes = 1073741824
```
Default configuration in `v1.x`:
```toml
max_txs_bytes = 67108864
```

### Deprecated Parameters:

Some parameters have been deprecated in `v1.x` and will be removed in future releases.

#### `[consensus]` section:

The `skip_timeout_commit` [has been deprecated](https://github.com/cometbft/cometbft/pull/3093) in CometBFT `v1`.
In a future release it [will be removed](https://github.com/cometbft/cometbft/pull/2892) in favor of `timeout_commit=0`

```toml
# Deprecated: set `timeout_commit` to 0 instead.
skip_timeout_commit = false
```

## Genesis File (`genesis.json`)

- **Genesis File Changes**: The format and structure of the genesis file changed in `v1`. Review the official
[documentation](https://docs.cometbft.com/v1.0/references/config/genesis.json) for `v1` to identify any new fields or
modified data types that need to be included.

- **Validation**: After updating your genesis file, validate the file's structure
and ensure compatibility with `v1`. This step is crucial to avoid issues during node initialization.

### PTBS synchrony parameters

There are two new parameters related to PBTS, the precision and the message delay. For more information about these parameters
please see the [Proposer-Based Timestamps](#proposer-based-timestamps-pbts) section in this document.

```
    "synchrony": {
        "precision": "500000000",
        "message_delay": "2000000000"
    },
```

### Feature parameters

The `ABCI` parameters have been deprecated.

```
    "abci": {
      "vote_extensions_enable_height": "0"
    }
```

Please use the new `Feature` parameters. You can specify two parameters, one related to vote extensions,
and the other for PBTS (check the documentation [here](../../explanation/core/proposer-based-timestamps.md#featureparamspbtsenableheight) for more information).

```
    "feature": {
      "vote_extensions_enable_height": "0",
      "pbts_enable_height": "0"
    }
```

### Block parameters

The `Block` consensus parameters default values have been updated.

In `v0.38.x`, the default values were:

```
    "block": {
      "max_bytes": "22020096",
      "max_gas": "-1"
    },
```

And in `v1.x` the default parameters are:

```
    "block": {
      "max_bytes": "4194304",
      "max_gas": "10000000"
    },
```

For some context on these value updates please refer to this [PR](https://github.com/cometbft/cometbft/pull/1518).

## New Features

The introduction of CometBFT `v1` brings numerous new features. This section will outline the
most significant additions in `v1`. It is essential to comprehend these features in order to
fully take advantage of CometBFT `v1`.

### Proposer-Based Timestamps (PBTS)

TODO

### Data Companion API

CometBFT `v1.x` introduces support for a new Data Companion Pull API as specified in
[ADR-101](https://docs.cometbft.com/v1.0/references/architecture/adr-101-data-companion-pull-api.md)

There is a whole new section in the `config.toml` to support the new Data Companion gRPC services.

Please refer to the [documentation](https://docs.cometbft.com/v1.0/explanation/data-companion/intro) site for additional
information.

Basically, in the `config.toml` of CometBFT `v1.x`, if the `laddr` parameter in the `[grpc]` section is not specified,
all the services will be **disabled**. If an address is specified, the node operator can selectively choose
which services should be enabled or disabled.

### Database backend

CometBFT `v1` adds experimental support for [Pebble](https://github.com/cockroachdb/pebble) as a database backend.

Use `pebbledb` build tag (`go build -tags pebbledb`) to build a binary that supports this database
backend. Then update the `config.toml` parameter to use this database:

```toml
db_backend = "pebbledb"
```

> **NOTE**: Currently, there is no support available for migrating existing blockchain and state data from a
previous database type (e.g. `goleveldb`) to `pebbledb` for existing network upgrades. If the node
is starting from scratch (not copying or re-using old database files) and performing a block sync,
it can use a binary with this new database. (**VALIDATE**)

## API Changes

As part of the upgrade to CometBFT` v1`, breaking changes have been made to some APIs, enhancing functionality,
These updates may impact how your applications interact with the CometBFT node, necessitating adjustments to your
existing API calls.

It is essential to review these changes carefully to ensure that your application remain functional and take full
advantage of the improvements introduced in `v1`.

### ABCI APIs

TODO

## Removed features

### gRPC Broadcast API

CometBFT `v0.38.x` offered a simplistic gRPC support with only one method equivalent to the `/broadcast_tx_commit` endpoint.
This has been [removed](https://github.com/cometbft/cometbft/pull/659) from CometBFT `v1.x` in favor of
the new [Data Companion gRPC services](https://docs.cometbft.com/v1.0/explanation/data-companion/grpc).

The following configuration parameters in `config.toml` are not applicable in `v1.x` anymore:

```toml
[rpc]

grpc_laddr = ""
grpc_max_open_connections = 900
```

## Deprecation Notices

Review the deprecation notices in the release notes. If you are using any deprecated features, plan to refactor your code or configurations accordingly.

### Deprecated Databases

CometBFT `v1` is upgrading to [cometbft-db v0.14.0](https://github.com/cometbft/cometbft-db/blob/main/CHANGELOG.md#v0140),
which deprecates `cleveldb` and `boltdb`. If you are currently using any of these databases, please note that we
discourage their use, as we plan to discontinue support in future releases.

## Testing and Validation

### Test Your Configuration

Before deploying the upgraded version in a production environment, thoroughly test the new configuration locally or in
a staging or testnet environment.

Monitor logs for any warnings or errors during startup and operation.

### Performance Testing

Conduct performance tests to evaluate the benefits of the upgrade. Compare the results with your previous setup to
ensure improvements are realized.

 ## Additional Resources

- **Release Notes**: Review the [official CHANGELOG.md](https://github.com/cometbft/cometbft/blob/main/CHANGELOG.md) for detailed information on changes and improvements in `v1`.
- **Documentation**: Consult the [CometBFT v1 documentation](https://docs.cometbft.com/v1.0/) for specifics on configuration
parameters and API usage.
- **Community Support**: Engage with the [CometBFT community](https://linktr.ee/cometbft) for assistance or to share
experiences regarding the upgrade process.

By following this guide, you should be well-prepared to successfully upgrade from CometBFT `v0.38.x` to `v1.x`. Ensure you stay
updated with community feedback and best practices post-upgrade.
